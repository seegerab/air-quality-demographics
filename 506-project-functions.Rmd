---
title: "506 Project Functions"
output: html_document
date: '2022-10-23'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r warning = FALSE, message = FALSE}
library(writexl)
library(dplyr)
suppressWarnings(library(kableExtra))
library(tidycensus)
library(tigris)
library(tidyverse)
```

```{r message = FALSE, echo = TRUE, results = "hide"}
census_api_key("2567b1d4e4122ec716ee4e55fce64f07a9cbae74", install = TRUE, overwrite = TRUE)
Sys.setenv(CENSUS_API_KEY='Your API key here as a string' )
# Reload .Renviron
readRenviron("~/.Renviron")
Sys.getenv("CENSUS_API_KEY")
```

# Function 1

Create a function to extract data from the Census API
- Inputs: state, year
- Output: a dataframe with the population for each demographic group for each year for each county in the state

```{r}
census_var <- load_variables(year = 2010, dataset = 'sf1', cache=T)

# Total Race Population
#total_race <- census_race[grepl("^Total$", census_race$label), ][1,]
#total_race$race <- c("Total")

# All races except for H&L
census_race <- census_var[grepl("^RACE$", census_var$concept), ]
census_race1 <- census_race[grepl("^Total!!", census_race$label), ]
census_race1$race <- substring(census_race1$label, 8)
races <- census_race1 %>% filter(
  race %in% c("White alone", "Black alone", 
                   "American Indian and Alaska Native alone", "Asian alone", 
                   "Native Hawaiian and Other Pacific Islander alone", "Some Other Race alone"))

# Total H&L
race_hl <- census_var[grepl("^HISPANIC OR LATINO ORIGIN BY RACE", census_var$concept), ]
total_hl <- race_hl[grepl("^Total$", race_hl$label), ]
total_hl$race <- c("Hispanic or Latino")

all_races <- rbind(races, total_hl) # don't include total_race
race_codes <- all_races[,1]
race_codes <- as.vector(unlist(race_codes))
```

```{r}
county_pop <- get_decennial(geography = "county", 
                                  variables = c(race_codes), 
                                  year = 2010, state = "CA",
                                  geometry = TRUE)

county_pop <- county_pop %>% group_by(NAME, variable) %>% summarize(population = value)
```

```{r}
pop_func <- function(x,y){
  tryCatch(
    expr = {
       df <- get_decennial(geography = "county", 
                                  variables = c(race_codes), 
                                  year = y, state = x,
                                  geometry = TRUE)
      df <- df %>% group_by(NAME, variable) %>% summarize(population = value)
      if(str_detect(x, "^[:upper:]+$") == FALSE){stop("State abbreviations are two capital letters")} 
      else{return(df)}
      },
    error = {
      if (nchar(x) != 2){"The function only accepts state abbreviations"}
      if(is.character(x) == FALSE){"State abbreviations are two letter strings"}
      if (nchar(y) != 4 | is.numeric(y) == FALSE){"Years must be four digits long"}
      }
    )
}
```

```{r}
pop_func("CA", 2010)
```


